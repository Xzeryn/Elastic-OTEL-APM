# =============================================================================
# PROCUREMENT SIMULATOR - KUBERNETES DEPLOYMENT TEMPLATE
# =============================================================================
# Deploys the APM traffic simulator as a Kubernetes pod.
# Creates realistic data (invoices, documents, payments) with auto-cleanup.
#
# SETUP:
#   1. Copy this file to simulator-deployment.yaml
#   2. Replace <dockerhub-username> with your Docker Hub username
#   3. Replace <your-domain> with your application domain
#
# USAGE:
#   kubectl apply -f simulator-deployment.yaml -n demo-apps
#   kubectl delete -f simulator-deployment.yaml -n demo-apps
#
# VIEW LOGS:
#   kubectl logs -f deployment/procurement-simulator -n demo-apps
#
# SCALE:
#   kubectl scale deployment/procurement-simulator --replicas=0 -n demo-apps  # Stop
#   kubectl scale deployment/procurement-simulator --replicas=1 -n demo-apps  # Start
# =============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: procurement-simulator
  namespace: demo-apps
  labels:
    app: procurement-simulator
    component: testing
spec:
  replicas: 1
  selector:
    matchLabels:
      app: procurement-simulator
  template:
    metadata:
      labels:
        app: procurement-simulator
        component: testing
      annotations:
        # Explicitly disable OTEL auto-instrumentation - simulator should not be traced
        instrumentation.opentelemetry.io/inject-nodejs: "false"
        instrumentation.opentelemetry.io/inject-python: "false"
        instrumentation.opentelemetry.io/inject-java: "false"
    spec:
      containers:
      - name: simulator
        # TODO: Replace with your Docker Hub username
        image: <dockerhub-username>/procurement-simulator:v4
        imagePullPolicy: Always
        env:
        # TODO: Replace with your application domain
        # Target URL (use external URL for real RUM traces)
        - name: BASE_URL
          value: "https://<your-domain>"
        
        # API URL (same as BASE_URL for external access)
        - name: API_URL
          value: "https://<your-domain>"
        
        # Delay between actions (ms)
        - name: ACTION_DELAY
          value: "2000"
        
        # Delay between cycles (ms)
        - name: CYCLE_DELAY
          value: "5000"
        
        # Enable/disable document uploads
        - name: ENABLE_UPLOADS
          value: "true"
        
        # Upload every N cycles
        - name: UPLOAD_FREQUENCY
          value: "5"
        
        # Enable/disable invoice creation
        - name: ENABLE_INVOICES
          value: "true"
        
        # Create invoice every N cycles
        - name: INVOICE_FREQUENCY
          value: "3"
        
        # Cleanup old records every N cycles
        - name: CLEANUP_FREQUENCY
          value: "10"
        
        # Delete simulator records older than X hours
        - name: CLEANUP_AGE_HOURS
          value: "24"
        
        # Run headless (must be true in K8s)
        - name: HEADLESS
          value: "true"
        
        # Maximum cycles (0 = infinite)
        - name: MAX_CYCLES
          value: "0"
        
        # Verbose logging
        - name: VERBOSE
          value: "false"
        
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        
        # Temporary storage for test files
        volumeMounts:
        - name: test-files
          mountPath: /app/test-files
      
      volumes:
      - name: test-files
        emptyDir: {}
      
      # Optional: Use imagePullSecrets if your image is private
      # imagePullSecrets:
      # - name: dockerhub-credentials

---
# =============================================================================
# ALTERNATIVE: CRONJOB FOR SCHEDULED SIMULATION
# =============================================================================
# Uncomment to run simulator on a schedule instead of continuously.
# =============================================================================

# apiVersion: batch/v1
# kind: CronJob
# metadata:
#   name: procurement-simulator-cron
#   namespace: demo-apps
# spec:
#   # Run every 30 minutes
#   schedule: "*/30 * * * *"
#   jobTemplate:
#     spec:
#       template:
#         spec:
#           containers:
#           - name: simulator
#             image: <dockerhub-username>/procurement-simulator:v4
#             env:
#             - name: BASE_URL
#               value: "https://<your-domain>"
#             - name: MAX_CYCLES
#               value: "3"
#             - name: ENABLE_INVOICES
#               value: "true"
#             - name: ENABLE_UPLOADS
#               value: "true"
#             - name: CLEANUP_FREQUENCY
#               value: "1"  # Cleanup on first cycle
#           restartPolicy: OnFailure
